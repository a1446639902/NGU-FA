<!DOCTYPE html>
<html>
<head>
    <title>存款业务页面</title>
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link type="text/css" rel="stylesheet" href="../lib/layui/css/layui.css"/>
    <!--下列表格要导入的文件-->
    <link rel="stylesheet" href="../lib/layuimini/lib/layui-v2.5.5/css/layui.css" media="all">
    <link rel="stylesheet" href="../lib/layuimini/css/public.css" media="all">
    <script src="../lib/layuimini/lib/layui-v2.5.5/layui.js" charset="utf-8"></script>
    <script src="../lib/layuimini/js/lay-config.js?v=1.0.4" charset="utf-8"></script>
    <!--工具条-->
    <script type="text/html" id="userToolBar">
        <div style="float:right">
            <button class="layui-btn layui-btn-normal layui-bg-green layui-btn-sm" lay-event="add"><i
                    class="layui-icon">&#xe654;</i>添加存款</button>
        </div>
        <br/>
        <form class="layui-form layui-col-space5">
            <div class="layui-inline layui-show-xs-block">
                <label class="layui-form-label layui-bg-green" style="width: 110px;text-align: center" >业务类型</label>
                <div class="layui-inline layui-show-xs-block" style="text-align: center">
                    <select name="searchBusinessType" id="searchBusinessType" >
                        <option value="">请选择业务类型</option>
                        <option value="1">三天存款</option>
                        <option value="2">七天存款</option>
                        <option value="3">活期存款</option>
                    </select>
                </div>
            </div>
            <div class="layui-inline layui-show-xs-block">
                <label class="layui-form-label layui-bg-green" style="width: 110px;text-align: center">到期时间</label>
                <div class="layui-inline layui-show-xs-block">
                    <input class="layui-input"  autocomplete="off" placeholder="请选择日期" name="dateEnd" id="start">
                </div>
            </div>
            </div>
            <div class="layui-inline layui-show-xs-block">
                <button class="layui-btn"  lay-submit="" lay-filter="search" lay-event="search"><i class="layui-icon">&#xe615;</i>搜索</button>
            </div>
        </form>
    </script>


    <script type="text/javascript">

        layui.use(['element', 'form', 'table', 'layer', 'laydate','tableSelect'], function () {
            var layer = layui.layer;
            var $ = layui.$;
            var table = layui.table;
            var form = layui.form;
            var tableSelect = layui.tableSelect;
            var laydate = layui.laydate;

            //执行一个laydate实例
            laydate.render({
                elem: '#start',//指定元素
            });
            //执行一个laydate实例
            laydate.render({
                elem: '#end'//指定元素
            });
            //执行一个laydate实例
            laydate.render({
                elem: '#up'//指定元素
            });
            //新增提交
            form.on('submit(addsubmit)', function(data){
                var formData=$('#addform').serialize();
                $.post("../deposit/insertDeposit",formData,function(msg){
                    if(msg>0){
                        table.reload('userTable');
                        layer.closeAll();
                        layer.msg('添加成功',{
                            title : '提示',
                            area : [ '200px',
                                '140px' ],
                            time : 0,
                            btn : [ '知道了' ]
                        });
                    }else{
                        layer.closeAll();
                        layer.msg('添加失败',{
                            title : '提示',
                            area : [ '200px',
                                '140px' ],
                            time : 0,
                            btn : [ '知道了' ]
                        });
                    }
                });
                return false;
            });

            table.render({
                elem: '#userTable',
                url: '../deposit/selectDeposit',
                page: true,
                height: 498,
                toolbar: '#userToolBar',//显示在表头的工具条
                cellMinWidth:60,
                minLength:80,
                cols: [
                    [ //表头
                        {field: 'fundId', title: '基金Id', width:110,align:'center'}
                        ,{field: 'outAccountId', title: '流出账户Id', width:150,align:'center'}
                        ,{field: 'outAccountName', title: '流出账户', width:165,align:'center'}
                        ,{field: 'inAccountId', title: '流入账户Id', width: 150,align:'center'}
                        ,{field: 'inAccountName', title: '流入账户', width:165,align:'center'}
                        ,{field: 'businessDate', title: '业务时间', width:165,align:'center',hidden:true}
                        ,{field: 'depositId', title: '存款业务Id', width:165,align:'center',hidden:true}
                        ,{field: 'businessType', title: '业务类型', width: 145,align:'center',
                            templet:function (item) {
                                if(item.businessType==1){
                                    return '定期三天'
                                }
                                else if(item.businessType==2){
                                    return '定期七天'
                                }
                                else if(item.businessType==3){
                                    return '活期'
                                }
                            }}
                        ,{field: 'money', title: '存款金额', width:160,align:'center'}
                        ,{field: 'endDate', title: '到期日期', width:150,align:'center'}
                        ,{field: 'flag', title: '是否处理', width:145,align:'center',
                            templet:function (item) {
                                 if(item.flag==0){
                                   return '未办理'
                                 }
                                 else if(item.flag==1){
                                     return '已办理'
                                 }
                            }
                        }
                        ,{field: 'right', title: '操作',width: 180, align:'center', toolbar: '#barDemo'}
                    ]
                ]
            });
            //给工具条的按钮添加事件
            table.on('toolbar(userTable)',function (obj) {
                //获取选中复选框的对象，
                var checkStatus=table.checkStatus(obj.config.id);//得到表格选中行的ID
                switch (obj.event) {
                    case 'add':
                        var index=layer.open({
                            type: 1,
                            title: '添加存款',
                            closeBtn: 1,
                            move:false,
                            content:$("#addContent"),
                            area: ['893px', '550px'],
                            btn:[]
                        });
                        form.render();
                        //全屏
                       /* layer.full(index);*/
                        break;
                    case 'search':
                        alert("搜索");
                        var businessType= $("#searchBusinessType").val();
                        var dateEnd=$("#start").val();
                        alert(businessType);
                        alert(dateEnd);
                        //表格的重新加载事件
                        table.reload('userTable', {
                            method: 'post'
                            , where: {
                                'businessType': businessType,
                                'dateEnd':dateEnd
                            }
                            , page: {
                                curr: 1
                            }
                        });

                        break;
                    case 'deleteAll':
                        var data = checkStatus.data;
                        //    layer.alert(JSON.stringify(data));
                        if(data.length==0){
                            layer.msg("请至少选择一条数据",)
                        }else
                        {
                            var ids=[];
                            for (var i = 0; i <data.length; i++) {
                                ids.push(data[i].userId);
                            }
                            layer.confirm('真的删除行么',{icon: 2}, function(index){
                                layer.close(index);
                                $.post("../user/deleteUser", {userId:ids.join(',')},function(msg){
                                    table.reload('userTable');
                                    layer.msg('删除'+checkStatus.data.length+'条记录', {
                                        title:'提示',
                                        area: ['200px', '140px'],
                                        time: 0,
                                        btn: ['知道了']
                                    });
                                });
                            });
                        }
                        break;
                }
            });
            //给表格编辑，删除按钮添加点击事件
            table.on('tool(userTable)', function(obj) {
                var data = obj.data;//得到删除行整行的数据
                var endDateHaoMiao = new Date(data.endDate).getTime();//获得到期日期的时间
                var dateTimeHaoMiao = new Date(data.businessDate).getTime();//获得业务日期时间
                var nowTimeHaoMiao = new Date().getTime();//获得当前日期的时间

               /* alert(data.userId);*/
                if (obj.event === 'del') {
                    if(data.flag==1){
                        layer.msg('已处理业务无法删除');
                    }
                    else if(data.flag==0) {
                        layer.confirm('真的删除行么', {icon: 1}, function (index) {
                            layer.close(index);
                            $.post("../deposit/deleteDeposit","depositId="+data.depositId,function (msg) {
                                if(msg>0){
                                    layer.msg('删除成功');
                                }
                                else{
                                    layer.msg('出现一个错误处理失败');
                                }
                                table.reload('userTable');
                            });


                        });
                    }
                }
                else if (obj.event === 'edit') {
                        if(data.flag==1){
                            layer.msg('已处理不可重复操作');
                        }
                        else if(endDateHaoMiao>nowTimeHaoMiao && data.businessType!=3){
                            layer.msg('存款未到期无法处理');
                        }
                        else{
                            layer.confirm('确认对此存款进行到期处理?',{icon: 1}, function(index){
                                layer.close(index);
                                $.post("../deposit/updateDeposit",data,function(msg){
                                        if(msg>0){
                                            layer.msg('已处理');
                                        }else{
                                            layer.msg('出现一个错误处理失败');
                                        }
                                    });
                                table.reload('userTable');
                            });
                        }
                    layer.full(index);
                    }


            })
            //新增流出账号的下拉表格
            tableSelect.render({
                elem:'#insertBlankCardCode',
                checkedKey:'blankCardCode',
                table:{
                    url:'../account/selectAccount',
                    cellMinWidth: 60,
                    cols:[
                        [   {type:'radio'},
                            {field:'accountName',title:'账户名称',width:100},
                            {field: 'blankCardCode',title:'银行卡号',width: 100},
                            {field: 'blankName',title: '银行名称'},
                            {field: 'accountId',title: '账号Id',hidden:true}
                        ]
                    ]
                },
                done:function (elem,data) {
                    //elem:返回之前input对象；data:表格返回的选中的数据 []
                    var newJson=[];
                    //遍历选中的数据
                    $.each(data.data,function (index,item) {
                        newJson.push(item.blankCardCode);
                        $("#insertOutAccountId").val(item.accountId);//给隐藏域中的val赋值
                        $("#insertOutAccountName").val(item.accountName);//给账户名称中的val赋值
                        $("#outBlankName").val(item.blankName);//给银行名称中的val赋值
                    });
                    elem.val(newJson.join(","));//给输入框里显示的值赋值

                }
            })
            //新增流入账户的下拉表格
            tableSelect.render({
                elem:'#insertInBlankCardCode',
                checkedKey:'blankCardCode',
                table:{
                    url:'../account/selectAccount',
                    cellMinWidth: 60,
                    cols:[
                        [   {type:'radio'},
                            {field:'accountName',title:'账户名称',width:100},
                            {field: 'blankCardCode',title:'银行卡号',width: 100},
                            {field: 'blankName',title: '银行名称'},
                            {field: 'accountId',title: '账号Id',hidden:true}
                        ]
                    ]
                },
                done:function (elem,data) {
                    //elem:返回之前input对象；data:表格返回的选中的数据 []
                    var newJson=[];
                    //遍历选中的数据
                    $.each(data.data,function (index,item) {
                        newJson.push(item.blankCardCode);
                        $("#insertInAccountId").val(item.accountId);//给隐藏域中的val赋值
                        $("#insertInAccountName").val(item.accountName);//给账户名称中的val赋值
                        $("#inBlankName").val(item.blankName);//给银行名称中的val赋值
                    });
                    elem.val(newJson.join(","));//给输入框里显示的值赋值

                }
            })

        });
        function myclose() {
            parent.layer.closeAll();
        }
    </script>
</head>
<body style="overflow: auto; background-color: white;"
      class="layui-view-body layui-content">
<div>
    <!--表格-->
    <table id="userTable" lay-filter="userTable"></table>
    <!--工具条-->
    <div style="display: none;" id="barDemo">
        <a class="layui-btn layui-btn-xs" lay-event="edit"><i
                class="layui-icon">&#xe642;</i>到期处理</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del"><i
                class="layui-icon">&#xe640;</i>删除</a>

    </div>
</div>
<!--增加的div内容-->
<div id="addContent"
     style="display: none; height: 100%; height: 100%; text-align: center;">
    <form id="addform" lay-filter="addform"
          class="layui-form layui-form-pane"
          style="margin: 0px auto; display: inline-block;">
        <fieldset class="layui-elem-field layui-field-title"
                  style="margin-top: 10px;">
            <legend>流出账户</legend>
        </fieldset>
        <div>
            <div class="layui-inline layui-show-xs-block">
                <input type="hidden" name="outAccountId" id="insertOutAccountId">
                <label class="layui-form-label layui-bg-green" style="width: 110px;text-align: center">流出账户</label>
                <div class="layui-inline layui-show-xs-block">
                    <input class="layui-input"  autocomplete="off" placeholder="请选择流出账户" id="insertBlankCardCode" name="blankCardCode">
                </div>
            </div>
            <div class="layui-inline layui-show-xs-block">
                <label class="layui-form-label layui-bg-green" style="width: 110px;text-align: center">账户名称</label>
                <div class="layui-inline layui-show-xs-block">
                    <input class="layui-input"  autocomplete="off" placeholder="请选择账户名称" name="outAccountName" id="insertOutAccountName">
                </div>
            </div>
        </div>
        <br>
        <div>
            <div class="layui-inline layui-show-xs-block">
                <label class="layui-form-label layui-bg-green" style="width: 110px;text-align: center">账户银行</label>
                <div class="layui-inline layui-show-xs-block">
                    <input class="layui-input"  autocomplete="off" placeholder="请选择账户银行" name="outBlankName" id="outBlankName">
                </div>
            </div>
            <div class="layui-inline layui-show-xs-block">
                <label class="layui-form-label layui-bg-green" style="width: 110px;text-align: center">存款金额</label>
                <div class="layui-inline layui-show-xs-block">
                    <input class="layui-input"  autocomplete="off" placeholder="请输入存款金额" name="money">
                </div>
            </div>
        </div>
        <fieldset class="layui-elem-field layui-field-title"
                  style="margin-top: 50px;">
            <legend>流入账户</legend>
        </fieldset>
        <div>
            <div class="layui-inline layui-show-xs-block">
                <input type="hidden" name="inAccountId" id="insertInAccountId">
                <label class="layui-form-label layui-bg-green" style="width: 110px;text-align: center">流入账户</label>
                <div class="layui-inline layui-show-xs-block">
                    <input class="layui-input"  autocomplete="off" placeholder="请选择流入账户" name="inBlankCardCode" id="insertInBlankCardCode">
                </div>
            </div>
            <div class="layui-inline layui-show-xs-block">
                <label class="layui-form-label layui-bg-green" style="width: 110px;text-align: center">账户名称</label>
                <div class="layui-inline layui-show-xs-block">
                    <input class="layui-input"  autocomplete="off" placeholder="请选择账户名称" name="inAccountName" id="insertInAccountName">
                </div>
            </div>
        </div>
        <br>
        <div>
            <div class="layui-inline layui-show-xs-block">
                <label class="layui-form-label layui-bg-green" style="width: 110px;text-align: center">账户银行</label>
                <div class="layui-inline layui-show-xs-block">
                    <input class="layui-input"  autocomplete="off" placeholder="请选择账户银行" name="inBlankName" id="inBlankName">
                </div>
            </div>
            <div class="layui-inline layui-show-xs-block">
                <label class="layui-form-label layui-bg-green" style="width: 110px;text-align: center" >业务类型</label>
                <div class="layui-inline layui-show-xs-block" style="text-align: center;width: 187px">
                    <select name="businessType" >
                        <option value="">请选择业务类型</option>
                        <option value="1">三天存款</option>
                        <option value="2">七天存款</option>
                        <option value="3">活期存款</option>
                    </select>
                </div>
            </div>
        </div>
        <br>
        <div>
            <div class="layui-inline layui-show-xs-block">
                <label class="layui-form-label layui-bg-green" style="width: 110px;text-align: center">业务日期</label>
                <div class="layui-inline layui-show-xs-block">
                    <input class="layui-input"  autocomplete="off" placeholder="请选择业务日期" name="businessDate" id="end">
                </div>
            </div>
            <div class="layui-inline layui-show-xs-block">
                <label class="layui-form-label layui-bg-green" style="width: 110px;text-align: center">到期日期</label>
                <div class="layui-inline layui-show-xs-block">
                    <input class="layui-input"  autocomplete="off" placeholder="请选择到期日期" name="endDate" id="up">
                </div>
            </div>
        </div>
        <div style="position: absolute; bottom: 0px; left: 40%;">
            <button class="layui-btn" lay-submit="" lay-filter="addsubmit" >
                <i class="layui-icon">&#x1005;</i>添加
            </button>
            <button class="layui-btn layui-bg-red cancel" type="button" onclick="myclose()">
                <i class="layui-icon">&#x1006;</i>取消
            </button>
        </div>
    </form>
</div>
</body>
</html>